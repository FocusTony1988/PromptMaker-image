<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sora Prompt Maker AI – High Performance Edition</title>
  
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Optional Config Load -->
  <script src="config.js" onerror="console.log('No config.js found, using manual input.')"></script>

  <style>
    :root {
      --bg-color: #020617; --sidebar-bg: #0f172a; --card-bg: #1e293b;
      --accent: #6366f1; --accent-hover: #4f46e5; --text-main: #f8fafc;
      --text-muted: #94a3b8; --border: #334155; --glow: 0 0 20px rgba(99, 102, 241, 0.15);
      --success: #10b981; --warning: #f59e0b;
    }
    * { box-sizing: border-box; scrollbar-width: thin; scrollbar-color: var(--border) var(--bg-color); }
    body { margin: 0; padding: 0; font-family: 'Inter', system-ui, sans-serif; background-color: var(--bg-color); color: var(--text-main); display: flex; flex-direction: column; min-height: 100vh; font-size: 14px; }
    
    /* Header */
    header { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(10px); padding: 0.8rem 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; height: 60px; }
    h1 { margin: 0; font-size: 1.1rem; font-weight: 700; display: flex; align-items: center; gap: 10px; letter-spacing: -0.01em; }
    h1 i { color: var(--accent); }
    
    .mode-switch { background: var(--card-bg); border-radius: 6px; padding: 3px; display: flex; border: 1px solid var(--border); }
    .mode-btn { background: transparent; border: none; color: var(--text-muted); padding: 6px 14px; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 0.8rem; display: flex; gap: 6px; align-items: center; transition: all 0.2s; }
    .mode-btn:hover { color: var(--text-main); }
    .mode-btn.active { background: var(--accent); color: white; box-shadow: 0 1px 4px rgba(0,0,0,0.2); }

    /* Layout */
    .container { display: grid; grid-template-columns: 420px 1fr; height: calc(100vh - 60px); overflow: hidden; }
    @media (max-width: 1000px) { .container { grid-template-columns: 1fr; height: auto; display: block; overflow: auto; } }
    
    .sidebar { background: var(--sidebar-bg); border-right: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; height: 100%; min-width: 350px; }
    .scroll-area { flex: 1; overflow-y: auto; padding: 20px; }

    /* Smart Input Section */
    .smart-section {
      background: linear-gradient(180deg, rgba(99, 102, 241, 0.08) 0%, rgba(15, 23, 42, 0) 100%);
      padding: 20px; border-bottom: 1px solid var(--border);
    }
    .smart-label { font-size: 0.7rem; text-transform: uppercase; font-weight: 700; color: var(--accent); margin-bottom: 8px; letter-spacing: 0.5px; display: flex; align-items: center; gap: 6px; }
    .smart-textarea {
      width: 100%; background: rgba(0,0,0,0.2); border: 1px solid var(--border); color: white;
      border-radius: 6px; padding: 10px; font-family: inherit; font-size: 0.9rem; resize: vertical; min-height: 70px;
      margin-bottom: 10px; transition: all 0.2s;
    }
    .smart-textarea:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.15); background: rgba(0,0,0,0.4); }
    
    .smart-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .btn-smart { padding: 8px; font-size: 0.8rem; border-radius: 5px; border: 1px solid var(--border); cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 6px; background: var(--card-bg); color: var(--text-main); transition: all 0.15s; }
    .btn-smart:hover { background: #334155; transform: translateY(-1px); }
    .btn-magic { background: rgba(99, 102, 241, 0.15); border-color: rgba(99, 102, 241, 0.3); color: #a5b4fc; }
    .btn-magic:hover { background: var(--accent); color: white; border-color: var(--accent); }

    /* Forms */
    .category-header { color: var(--text-main); margin-top: 25px; margin-bottom: 12px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; border-bottom: 1px solid var(--border); padding-bottom: 5px; display: flex; align-items: center; gap: 8px; letter-spacing: 0.5px; }
    .category-header i { color: var(--accent); }
    .form-group { margin-bottom: 14px; }
    label { display: flex; justify-content: space-between; align-items: baseline; font-size: 0.85rem; margin-bottom: 5px; font-weight: 500; color: #cbd5e1; }
    .field-desc { font-size: 0.7rem; color: var(--text-muted); font-style: italic; font-weight: 400; opacity: 0.8; }
    
    select, input[type="text"], input[type="password"] { 
      width: 100%; background: #1e293b; border: 1px solid var(--border); color: var(--text-main); 
      padding: 10px; border-radius: 6px; font-family: inherit; font-size: 0.85rem; transition: border 0.15s; 
    }
    select:focus, input:focus { outline: none; border-color: var(--accent); background: #0f172a; }
    textarea { width: 100%; background: #1e293b; border: 1px solid var(--border); color: var(--text-main); padding: 10px; border-radius: 6px; font-family: inherit; font-size: 0.85rem; }
    textarea:focus { outline: none; border-color: var(--accent); }

    .toggle-wrapper { display: flex; align-items: center; gap: 10px; padding: 12px; background: rgba(99, 102, 241, 0.05); border-radius: 6px; border: 1px solid rgba(99, 102, 241, 0.15); margin-bottom: 15px; cursor: pointer; transition: background 0.2s; }
    .toggle-wrapper:hover { background: rgba(99, 102, 241, 0.1); }
    input[type="checkbox"] { accent-color: var(--accent); width: 16px; height: 16px; margin: 0; cursor: pointer; }
    .toggle-wrapper label { margin: 0; cursor: pointer; font-weight: 600; color: #e2e8f0; }

    /* Main Content */
    .main-content { padding: 25px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; height: 100%; background: var(--bg-color); }
    
    .action-bar { display: grid; grid-template-columns: 1fr 2fr; gap: 12px; }
    .btn { padding: 12px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.9rem; transition: all 0.2s; }
    .btn:active { transform: scale(0.98); }
    .btn-secondary { background: var(--card-bg); border: 1px solid var(--border); color: var(--text-main); }
    .btn-secondary:hover { background: #334155; }
    .btn-primary { background: linear-gradient(135deg, var(--accent), #4f46e5); color: white; box-shadow: var(--glow); }
    .btn-primary:hover { filter: brightness(1.1); }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; filter: grayscale(1); }

    .output-container { display: grid; grid-template-rows: auto 1fr; gap: 15px; flex: 1; min-height: 0; }
    
    /* Previews */
    .prompt-preview { background: var(--card-bg); border: 1px solid var(--border); border-radius: 8px; padding: 15px; }
    .prompt-preview h3 { margin: 0 0 8px 0; font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
    .prompt-text { font-family: 'Menlo', 'Monaco', monospace; color: #a5b4fc; line-height: 1.5; font-size: 0.85rem; white-space: pre-wrap; }
    
    .json-preview { background: #0d1117; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; min-height: 350px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
    .json-header { background: #161b22; padding: 8px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
    .json-header span { font-size: 0.8rem; font-weight: 600; color: var(--text-muted); }
    pre { margin: 0; padding: 15px; overflow: auto; font-size: 0.85rem; flex: 1; color: #e2e8f0; }
    
    /* API Settings */
    .api-settings { padding: 20px; background: rgba(15, 23, 42, 0.6); border-top: 1px solid var(--border); }
    .spinner { border: 2px solid rgba(255,255,255,0.2); border-top: 2px solid #fff; border-radius: 50%; width: 14px; height: 14px; animation: spin 0.8s linear infinite; display: none; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    /* Proxy Warning */
    #proxyWarn { background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); color: #fbbf24; padding: 8px; border-radius: 4px; margin-top: 8px; font-size: 0.75rem; display: none; }
  </style>
</head>
<body>

  <header>
    <h1><i class="fa-solid fa-layer-group"></i> Sora Prompt Maker <span style="font-size: 0.65em; background:var(--accent); color:white; padding:2px 6px; border-radius:4px; margin-left:8px;">PRO</span></h1>
    <div class="mode-switch">
      <button class="mode-btn active" id="modePhoto" onclick="setMode('photo')"><i class="fa-regular fa-image"></i> Foto</button>
      <button class="mode-btn" id="modeVideo" onclick="setMode('video')"><i class="fa-solid fa-video"></i> Video</button>
    </div>
  </header>

  <div class="container">
    <aside class="sidebar">
      <div class="smart-section">
        <div class="smart-label"><i class="fa-solid fa-wand-magic-sparkles"></i> AI Assistant</div>
        <textarea id="smartInput" class="smart-textarea" placeholder="Was möchtest du erstellen? (z.B. 'Eine Cyberpunk Frau mit Roboterhund im Regen')..."></textarea>
        <div class="smart-controls">
          <button class="btn-smart" onclick="randomizeForm()">
            <i class="fa-solid fa-shuffle"></i> Random
          </button>
          <button class="btn-smart btn-magic" id="btnAutoFill" onclick="runAutoFill()">
            <span class="spinner" id="spinAuto"></span>
            <i class="fa-solid fa-bolt"></i> Auto-Fill
          </button>
        </div>
      </div>

      <div class="scroll-area" id="controls">
        <!-- Dynamically filled by JS -->
      </div>

      <div class="api-settings">
        <label for="apiKey" style="display:flex; justify-content:space-between;">Gemini API Key <span id="keyStatus" style="font-size:0.8em; color:var(--text-muted);"></span></label>
        <input type="password" id="apiKey" placeholder="AIzaSy..." oninput="saveKey()" value="">
        
        <div style="display:flex; gap:10px; margin-top:10px;">
          <select id="modelSelect" style="font-size:0.8rem; padding:8px;">
            <option value="gemini-2.5-flash">Gemini 2.5 (Smartest)</option>
            <option value="gemini-1.5-flash">Gemini 1.5 (Fastest)</option>
          </select>
        </div>

        <div style="margin-top:12px; display:flex; align-items:center; gap:8px;">
          <input type="checkbox" id="useProxy" onchange="toggleProxyWarning()">
          <label for="useProxy" style="margin:0; font-weight:400; color:#cbd5e1; font-size:0.8rem; cursor:pointer;">Proxy nutzen (Fix für CORS)</label>
        </div>
        <div id="proxyWarn">
          <i class="fa-solid fa-shield-halved"></i> <b>Hinweis:</b> Anfrage läuft über öffentlichen Proxy (corsproxy.io).
        </div>
      </div>
    </aside>

    <main class="main-content">
      <div class="action-bar">
        <button class="btn btn-secondary" id="updateLocalBtn" onclick="generateLocalJSON()">
          <i class="fa-solid fa-code"></i> Schnell-Generierung
        </button>
        <button class="btn btn-primary" id="optimizeAiBtn" onclick="callGeminiAPI()">
          <span class="spinner" id="aiSpinner"></span>
          <i class="fa-solid fa-stars"></i> High-End AI Generierung
        </button>
      </div>

      <div class="output-container">
        <div class="prompt-preview">
          <h3>Aktive Parameter (Input)</h3>
          <div id="rawPrompt" class="prompt-text">Warte auf Konfiguration...</div>
        </div>
        <div class="json-preview">
          <div class="json-header">
            <span><i class="fa-brands fa-js"></i> Multi-Modal JSON Output</span>
            <button class="mode-btn" id="copyBtn" onclick="copyResult()"><i class="fa-regular fa-copy"></i> Kopieren</button>
          </div>
          <pre><code id="codeBlock" class="language-json">// JSON wird hier generiert...</code></pre>
        </div>
      </div>
    </main>
  </div>

  <script>
    let currentMode = 'photo'; // Default start mode

    // Optimized Resolution Map (Multiples of 64 for Diffusion Models)
    function getResolutionFromAspect(aspectRatio) {
      const map = {
        '16:9': { w: 1216, h: 832 }, 
        '9:16': { w: 832, h: 1216 }, 
        '1:1': { w: 1024, h: 1024 },
        '21:9': { w: 1536, h: 640 }, 
        '4:3': { w: 1152, h: 896 }, 
        '3:4': { w: 896, h: 1152 },
        '2.35:1': { w: 1536, h: 640 }, // Cinematic Scope
        '5:4': { w: 1152, h: 960 }
      };
      return map[aspectRatio] || { w: 1024, h: 1024 };
    }

    // --- CONFIGURATION ---
    const fieldConfig = [
      // --- PERSON ---
      { type: 'header', label: 'Hauptmotiv: Person', icon: 'fa-user', modes: ['photo', 'video'] },
      { type: 'checkbox', id: 'describePerson', label: 'Person beschreiben', default: true, modes: ['photo', 'video'] },
      { type: 'select', id: 'gender', label: 'Geschlecht', parent: 'describePerson', modes: ['photo', 'video'], options: [['Bitte wählen',''],['Frau','woman'],['Mann','man'],['Non-Binär','non-binary person'],['Android/Roboter','android robot'],['Cybernetisch','cybernetic human'],['Mystisches Wesen','mythical being']] },
      { type: 'select', id: 'ageGroup', label: 'Alter', parent: 'describePerson', modes: ['photo', 'video'], options: [['Bitte wählen',''],['Kind (5-10)','child, 8 years old'],['Teenager','teenager'],['Jung (20er)','20 years old, young adult'],['30er','30 years old'],['40er','40 years old, mature'],['50er','50 years old'],['60er','60 years old'],['Alt (70+)','70 years old, elderly']]},
      { type: 'select', id: 'ethnicity', label: 'Herkunft / Look', parent: 'describePerson', modes: ['photo', 'video'], options: [['Bitte wählen',''],['Amerikanisch','American'],['Deutsch/Nordeuropäisch','Germanic'],['Französisch','French'],['Italienisch/Mediterran','Mediterranean'],['Skandinavisch','Scandinavian'],['Osteuropäisch','Slavic'],['Afrikanisch','African descent'],['Ostasiatisch (Jap/Kor/Chi)','East Asian'],['Südasiatisch (Indien)','South Asian'],['Latino/Hispanic','Latino'],['Arabisch','Middle Eastern'],['Futuristisch','futuristic skin'],['Fantasy (Elf/Ork)','fantasy features']]},
      { type: 'select', id: 'bodyType', label: 'Körperbau', parent: 'describePerson', modes: ['photo', 'video'], options: [['Bitte wählen',''],['Schlank (Model)','slender model physique'],['Athletisch (Fit)','athletic toned body'],['Muskulös (Bodybuilder)','muscular physique'],['Kurvig','curvy figure'],['Realistisch (Durchschnitt)','average realistic body'],['Plus Size','plus size']] },
      { type: 'select', id: 'hairColor', label: 'Haare', parent: 'describePerson', modes: ['photo', 'video'], options: [['Bitte wählen',''],['Blond','blonde'],['Brunette','brunette'],['Schwarz','black'],['Rot (Ingwer)','ginger red'],['Platinweiß','platinum white'],['Grau','grey'],['Bunt (Pastell)','pastel colored'],['Neon','neon glowing hair'],['Glatze','bald']] },
      { type: 'select', id: 'hairStyle', label: 'Frisur', parent: 'describePerson', modes: ['photo', 'video'], options: [['Bitte wählen',''],['Lang & Glatt','long straight hair'],['Kurz (Pixie)','short pixie cut'],['Locken (Voluminös)','voluminous curly hair'],['Wellig','wavy hair'],['Pferdeschwanz','high ponytail'],['Bob','bob cut'],['Undercut','undercut'],['Messy Bun','messy bun'],['Nass Look','wet look hair']] },
      { type: 'select', id: 'eyeColor', label: 'Augen', parent: 'describePerson', modes: ['photo', 'video'], options: [['Bitte wählen',''],['Kristallblau','crystal blue'],['Smaragdgrün','emerald green'],['Tiefbraun','deep brown'],['Haselnuss','hazel'],['Stahlgrau','steel grey'],['Violett','violet'],['Leuchtend (Cyber)','glowing cybernetic']] },
      { type: 'select', id: 'expression', label: 'Ausdruck', parent: 'describePerson', modes: ['photo', 'video'], options: [['Bitte wählen',''],['Neutral/Cool','neutral cool expression'],['Verliebt/Romantisch','romantic loving gaze'],['Glücklich/Strahlend','happy beaming smile'],['Ernst/Fokussiert','serious focused look'],['Wütend/Intensiv','angry intense glare'],['Traurig/Melancholisch','sad melancholic'],['Überrascht','surprised expression'],['Verträumt','dreamy look'],['Verführerisch','seductive gaze']]},
      { type: 'select', id: 'clothing', label: 'Kleidung', parent: 'describePerson', modes: ['photo', 'video'], options: [['Bitte wählen',''],['Bikini / Swimwear','bikini swimwear'],['Casual (T-Shirt/Jeans)','casual t-shirt and jeans'],['Streetwear (Hoodie)','oversized hoodie streetwear'],['Business Anzug','tailored business suit'],['Abendkleid (Gala)','elegant evening gown'],['Lederjacke (Edgy)','black leather jacket'],['Sci-Fi Rüstung','futuristic sci-fi armor'],['Techwear','cyberpunk techwear'],['Mittelalter Robe','medieval robes'],['Sportbekleidung','active sportswear'],['Haute Couture','avant-garde haute couture']]},
      { type: 'textarea', id: 'action', label: 'Handlung / Pose', parent: 'describePerson', modes: ['photo', 'video'], placeholder: 'Was macht die Person genau? (z.B. "sitzt am Fenster und trinkt Kaffee", "rennt durch den Regen")...' },
      
      // --- ANIMALS ---
      { type: 'header', label: 'Tiere & Kreaturen', icon: 'fa-paw', modes: ['photo', 'video'] },
      { type: 'checkbox', id: 'describeAnimal', label: 'Tier / Kreatur hinzufügen', default: false, modes: ['photo', 'video'] },
      { type: 'select', id: 'animalType', label: 'Tierart', parent: 'describeAnimal', modes: ['photo', 'video'], options: [['Bitte wählen',''],['Hund','dog'],['Katze','cat'],['Wolf','wolf'],['Löwe','lion'],['Tiger','tiger'],['Bär','bear'],['Pferd','horse'],['Adler','eagle'],['Eule','owl'],['Drache','dragon'],['Phönix','phoenix'],['Roboter-Tier','robotic animal'],['Monster','monster creature']] },
      { type: 'select', id: 'animalAppearance', label: 'Aussehen', parent: 'describeAnimal', modes: ['photo', 'video'], options: [['Bitte wählen',''],['Niedlich/Fluffig','cute fluffy'],['Majestätisch','majestic'],['Bedrohlich','threatening'],['Cyborg','cybernetic'],['Geisterhaft','ghostly spectral'],['Realistisch','hyperrealistic'],['Leuchtend','bioluminescent glowing']] },
      { type: 'textarea', id: 'animalAction', label: 'Handlung des Tiers', parent: 'describeAnimal', modes: ['photo', 'video'], placeholder: 'z.B. "schläft auf dem Sofa", "jagt eine Beute"...' },

      // --- OBJECTS ---
      { type: 'header', label: 'Gegenstände & Fahrzeuge', icon: 'fa-car', modes: ['photo', 'video'] },
      { type: 'checkbox', id: 'describeObject', label: 'Objekt / Fokus hinzufügen', default: false, modes: ['photo', 'video'] },
      { type: 'select', id: 'objectCategory', label: 'Kategorie', parent: 'describeObject', modes: ['photo', 'video'], options: [['Bitte wählen',''],['Fahrzeug (Auto/Motorrad)','vehicle'],['Fahrzeug (Flug/Raum)','aircraft spacecraft'],['Waffe (Schwert/Gun)','weapon sword gun'],['Technologie','technology gadget'],['Essen/Trinken','food and drink'],['Möbel','furniture'],['Pflanze/Blume','plant flower'],['Artefakt','magical artifact']] },
      { type: 'select', id: 'objectMaterial', label: 'Material / Zustand', parent: 'describeObject', modes: ['photo', 'video'], options: [['Bitte wählen',''],['Gold/Glänzend','shiny gold'],['Rostiges Metall','rusty metal'],['Glas/Kristall','transparent crystal glass'],['Holz (Antik)','antique wood'],['Neon/Plastik','glowing neon plastic'],['Organisch','organic biological'],['Beschädigt/Kaputt','damaged broken']] },
      { type: 'textarea', id: 'objectDesc', label: 'Objekt Beschreibung', parent: 'describeObject', modes: ['photo', 'video'], placeholder: 'z.B. "ein roter Oldtimer Mustang", "ein leuchtendes Laserschwert"...' },

      { type: 'header', label: 'Environment & Mood', icon: 'fa-earth-americas', modes: ['photo', 'video'] },
      { type: 'select', id: 'sceneType', label: 'Genre / Stil', modes: ['photo', 'video'], options: [['Bitte wählen',''],['Cinematic Realism (Film)','cinematic realism'],['Cyberpunk / Sci-Fi','cyberpunk sci-fi'],['High Fantasy','high fantasy'],['Dark Horror','dark horror atmosphere'],['Film Noir (B&W)','film noir black and white'],['Steampunk','steampunk aesthetic'],['National Geographic (Doku)','documentary photography'],['Vintage 80s/90s','vintage retro aesthetic'],['Landschaftsfotografie','landscape photography'],['Editorial / Fashion','high fashion editorial'],['Weltraum / Space','outer space sci-fi'],['Unterwasser','underwater scene'],['Post-Apokalyptisch','post-apocalyptic world'],['Surrealismus','dreamy surrealism']]},
      { type: 'select', id: 'location', label: 'Ort (Location)', modes: ['photo', 'video'], options: [['Bitte wählen',''],['Luxus-Apartment (Innen)','luxury modern apartment'],['Schlafzimmer (Gemütlich)','cozy bedroom'],['Küche (Chef)','professional kitchen'],['Badezimmer (Spa)','luxury spa bathroom'],['Büro (Wolkenkratzer)','skyscraper office'],['Nachtclub (Neon)','neon nightclub'],['Supermarkt','supermarket aisle'],['Museum / Galerie','art gallery'],['Verlassene Ruinen','abandoned ruins'],['Dachterrasse (Nacht)','rooftop terrace at night'],['U-Bahn Station','gritty subway station'],['Tropischer Strand','pristine tropical beach'],['Verschneite Berge','snowy mountain peak'],['Futuristisches Labor','sci-fi laboratory'],['Raumschiff','spaceship interior'],['New York Straße','busy NYC street'],['Tokio (Regen)','rainy Tokyo street'],['Waldlichtung','mystical forest glade'],['Wüste','vast desert dunes'],['Weißes Studio (Clean)','clean white infinity studio']]},
      { type: 'select', id: 'era', label: 'Zeit / Ära', modes: ['photo', 'video'], options: [['Bitte wählen',''],['Modern (Heute)','modern day'],['Nahe Zukunft (2030)','near future 2030'],['Cyberpunk Zukunft (2077)','year 2077 cyberpunk'],['Y2K (2000er)','early 2000s Y2K aesthetic'],['90er Jahre','1990s aesthetic'],['80er Jahre (Synthwave)','1980s synthwave style'],['70er Jahre (Retro)','1970s retro'],['60er Jahre','1960s style'],['Viktorianisch (1800s)','Victorian era'],['Mittelalter','medieval era'],['Antike','ancient history']]},
      { type: 'select', id: 'lighting', label: 'Lichtsetzung', modes: ['photo', 'video'], options: [['Bitte wählen',''],['Cinematic (Dramatisch)','dramatic cinematic lighting'],['Soft Window Light','soft natural window light'],['Golden Hour','golden hour sunlight'],['Volumetrisch (Nebel)','volumetric god rays'],['Neon (Cyberpunk)','neon cyan and magenta lighting'],['Dark / Moody','dark moody low-key lighting'],['Studio Softbox','professional studio softbox'],['Rembrandt','Rembrandt lighting'],['Hartes Sonnenlicht','harsh sunlight']] },
      { type: 'select', id: 'weather', label: 'Wetter / Atmosphäre', modes: ['photo', 'video'], options: [['Bitte wählen',''],['Sonnig Klar','clear sunny sky'],['Regnerisch','heavy rain'],['Gewitter','stormy lightning'],['Schnee','heavy snow'],['Neblig','thick fog'],['Bewölkt','overcast sky'],['Staubig','dusty atmosphere']] },
      
      { type: 'header', label: 'Tech Specs (Kamera)', icon: 'fa-camera', modes: ['photo', 'video'] },
      { type: 'select', id: 'aspectRatio', label: 'Format (Aspect Ratio)', desc: 'Bestimmt die Auflösung.', modes: ['photo', 'video'], options: [['16:9 (Kino breit)','16:9'],['9:16 (TikTok/Reel)','9:16'],['1:1 (Instagram/Square)','1:1'],['21:9 (Ultrawide)','21:9'],['4:3 (TV Klassisch)','4:3'],['3:4 (Portrait)','3:4'],['2.35:1 (Anamorphic)','2.35:1']] },
      { type: 'select', id: 'viewAngle', label: 'Kamerawinkel', desc: 'Perspektive der Aufnahme.', modes: ['photo', 'video'], options: [['Bitte wählen',''],['Augenhöhe (Neutral)','eye-level shot'],['Froschperspektive (Low Angle)','low angle shot looking up'],['Vogelperspektive (High Angle)','high angle shot looking down'],['Top-Down (Draufsicht)','top-down drone view'],['Over-the-Shoulder','over-the-shoulder shot'],['Dutch Angle (Schräg)','dutch angle dynamic shot'],['POV (Ego)','first-person POV shot'],['Makro (Close-Up)','extreme macro close-up'],['Weitwinkel','wide angle shot'],['Fischauge','fisheye lens effect'],['Tele (Zoom)','telephoto compression'],['Selfie','selfie shot']] },
      { type: 'select', id: 'filmStock', label: 'Film Look / Analog', desc: 'Simuliert analoges Filmmaterial.', modes: ['photo', 'video'], options: [['Bitte wählen',''],['Digital Clean (8K)','digital crisp 8k'],['Kodak Portra 400','Kodak Portra 400 film grain'],['Cinestill 800T (Nacht)','Cinestill 800T halation'],['Fujifilm Velvia','Fujifilm Velvia 50'],['Kodak Tri-X (B&W)','Kodak Tri-X 400 black and white'],['Technicolor (Vintage)','vintage Technicolor'],['Bleach Bypass','bleach bypass gritty'],['VHS (Glitch)','VHS tape artifacting'],['Polaroid','Polaroid instant photo'],['IMAX (70mm)','IMAX 70mm film quality']] },
      { type: 'select', id: 'renderEngine', label: 'Render Stil (Digital)', desc: 'Für nicht-fotorealistische Stile.', modes: ['photo', 'video'], options: [['Bitte wählen',''],['Fotorealistisch (Raw)','photorealistic raw photo'],['Unreal Engine 5','Unreal Engine 5 render'],['Octane Render','Octane 3D render'],['Pixar / Disney','Pixar 3D animation style'],['Anime (Modern)','modern anime style'],['Ölgemälde','classic oil painting'],['Aquarell','watercolor painting'],['Concept Art','digital concept art'],['Vector Art','flat vector art'],['Pixel Art','retro pixel art']] },
      
      { type: 'header', label: 'Video Settings', icon: 'fa-film', modes: ['video'] },
      { type: 'select', id: 'cameraMotion', label: 'Kamerabewegung', modes: ['video'], options: [['Statisch (Stativ)','static tripod shot'],['Sanfter Zoom In','slow zoom in'],['Zoom Out','slow zoom out'],['Pan Rechts','smooth pan right'],['Pan Links','smooth pan left'],['Tracking Shot (Verfolgung)','dolly tracking shot'],['Handheld (Wackelig)','handheld shaky camera'],['FPV Drohne (Schnell)','fast FPV drone flight'],['Orbit (Kreisfahrt)','circular orbit shot']] },
      { type: 'select', id: 'fps', label: 'Framerate', modes: ['video'], options: [['24 FPS (Cinematic)','24'],['30 FPS (Standard)','30'],['60 FPS (Smooth)','60']] },
      { type: 'select', id: 'duration', label: 'Dauer', modes: ['video'], options: [['5 Sekunden','5s'],['10 Sekunden','10s']] },
      { type: 'select', id: 'loop', label: 'Loop', modes: ['video'], options: [['Nein','false'],['Ja','true']] }
    ];

    // --- UI LOGIC ---
    function setMode(mode) {
      currentMode = mode;
      document.getElementById('modePhoto').classList.toggle('active', mode === 'photo');
      document.getElementById('modeVideo').classList.toggle('active', mode === 'video');
      renderForm();
    }

    function renderForm() {
      const container = document.getElementById('controls');
      container.innerHTML = ''; 
      fieldConfig.forEach(field => {
        if (!field.modes.includes(currentMode)) return;
        if (field.type === 'header') {
          container.innerHTML += `<div class="category-header"><i class="fa-solid ${field.icon}"></i> ${field.label}</div>`;
          return;
        }
        const group = document.createElement('div');
        group.className = 'form-group';
        if(field.parent) group.dataset.parent = field.parent;

        if (field.type === 'checkbox') {
          group.className = 'toggle-wrapper';
          group.innerHTML = `<input type="checkbox" id="${field.id}" ${field.default ? 'checked' : ''} onchange="handleVisibility()"><label for="${field.id}">${field.label}</label>`;
        } else {
          let inputHTML = `<label>${field.label}`;
          if(field.desc) inputHTML += ` <span class="field-desc">${field.desc}</span>`;
          inputHTML += `</label>`;
          
          if (field.type === 'textarea') {
            inputHTML += `<textarea id="${field.id}" rows="2" placeholder="${field.placeholder || ''}" oninput="updateSummary()"></textarea>`;
          } else {
            let opts = field.options.map(o => `<option value="${o[1]}">${o[0]}</option>`).join('');
            inputHTML += `<select id="${field.id}" onchange="updateSummary()">${opts}</select>`;
          }
          group.innerHTML = inputHTML;
        }
        container.appendChild(group);
      });
      handleVisibility();
      updateSummary();
    }

    function handleVisibility() {
      // Helper function to manage a parent-child visibility relationship
      const manageVisibility = (parentId) => {
        const chk = document.getElementById(parentId);
        if (!chk) return;
        document.querySelectorAll(`[data-parent="${parentId}"]`).forEach(el => {
          el.style.display = chk.checked ? 'block' : 'none';
        });
      };

      // Manage all toggleable sections
      manageVisibility('describePerson');
      manageVisibility('describeAnimal');
      manageVisibility('describeObject');

      updateSummary();
    }

    function getVal(id) { const el = document.getElementById(id); return el ? el.value : ''; }

    function getSummaryText() {
      let parts = [];
      
      // Person
      if(document.getElementById('describePerson')?.checked) {
        const pParts = [getVal('ageGroup'), getVal('ethnicity'), getVal('gender'), getVal('bodyType')];
        const pText = pParts.filter(p => p && p !== '').join(' ');
        
        let details = [];
        if(getVal('hairColor') || getVal('hairStyle')) details.push(`Hair: ${getVal('hairColor')} ${getVal('hairStyle')}`);
        if(getVal('eyeColor')) details.push(`Eyes: ${getVal('eyeColor')}`);
        if(getVal('clothing')) details.push(`Wear: ${getVal('clothing')}`);
        if(getVal('expression')) details.push(`Mood: ${getVal('expression')}`);
        
        let mainSubj = `SUBJECT (PERSON): ${pText}` + (details.length ? ` (${details.join(', ')})` : '');
        if(getVal('action')) mainSubj += ` ACTION: ${getVal('action')}`;
        parts.push(mainSubj);
      }

      // Animal
      if(document.getElementById('describeAnimal')?.checked) {
         const aType = getVal('animalType');
         const aApp = getVal('animalAppearance');
         const aAct = getVal('animalAction');
         let aText = `SUBJECT (ANIMAL): ${aApp} ${aType}`;
         if(aAct) aText += ` ACTION: ${aAct}`;
         parts.push(aText);
      }

      // Object
      if(document.getElementById('describeObject')?.checked) {
         const oCat = getVal('objectCategory');
         const oMat = getVal('objectMaterial');
         const oDesc = getVal('objectDesc');
         let oText = `SUBJECT (OBJECT): ${oMat} ${oCat}`;
         if(oDesc) oText += ` DETAILS: ${oDesc}`;
         parts.push(oText);
      }
      
      const sParts = [getVal('sceneType'), getVal('location'), getVal('era')].filter(Boolean);
      if(sParts.length) parts.push(`SETTING: ${sParts.join(', ')}`);
      
      const envParts = [getVal('weather'), getVal('lighting')].filter(Boolean);
      if(envParts.length) parts.push(`ATMOSPHERE: ${envParts.join(', ')}`);
      
      const cParts = [getVal('viewAngle'), getVal('filmStock'), getVal('renderEngine')].filter(Boolean);
      if(cParts.length) parts.push(`STYLE: ${cParts.join(', ')}`);
      
      if (currentMode === 'video') {
          if(getVal('cameraMotion')) parts.push(`MOTION: ${getVal('cameraMotion')}`);
      }
      return parts.join('\n');
    }

    function updateSummary() {
      document.getElementById('rawPrompt').innerText = getSummaryText() || "Warte auf Eingabe...";
    }

    // --- RANDOMIZER ---
    function randomizeForm() {
      fieldConfig.forEach(field => {
        if (!field.modes.includes(currentMode)) return;
        if (field.type === 'select' && field.options.length > 1) {
          const el = document.getElementById(field.id);
          if(el) {
            const randomIdx = Math.floor(Math.random() * (field.options.length - 1)) + 1;
            el.value = field.options[randomIdx][1];
          }
        }
      });
      updateSummary();
    }

    // --- KEY MANAGEMENT ---
    function saveKey() {
      const key = document.getElementById('apiKey').value;
      localStorage.setItem('gemini_api_key', key);
      updateKeyStatus(true);
    }

    function loadKey() {
      const stored = localStorage.getItem('gemini_api_key');
      const input = document.getElementById('apiKey');
      
      // Load config from file if available
      if (typeof SECRET_CONFIG !== 'undefined' && SECRET_CONFIG.API_KEY) {
         input.value = SECRET_CONFIG.API_KEY;
         updateKeyStatus(true);
      } else if (stored) {
         input.value = stored;
         updateKeyStatus(true);
      } else {
         // Keep the value currently in HTML
         updateKeyStatus(!!input.value);
      }
    }

    function updateKeyStatus(found) {
      const el = document.getElementById('keyStatus');
      if (found) { el.innerText = '● Ready'; el.style.color = 'var(--success)'; }
      else { el.innerText = '○ Missing'; el.style.color = 'var(--text-muted)'; }
    }
    
    function toggleProxyWarning() {
      const useProxy = document.getElementById('useProxy').checked;
      document.getElementById('proxyWarn').style.display = useProxy ? 'block' : 'none';
    }

    // --- API HANDLER ---
    async function fetchFromApi(payloadText, outputElement, buttonId, spinnerId) {
      const apiKey = document.getElementById('apiKey').value;
      const useProxy = document.getElementById('useProxy').checked;
      const model = document.getElementById('modelSelect').value;
      
      if (!apiKey) {
        alert("API Key fehlt!");
        document.getElementById('apiKey').focus();
        throw new Error("Missing API Key");
      }

      const btn = document.getElementById(buttonId);
      const spinner = document.getElementById(spinnerId);
      
      btn.disabled = true; spinner.style.display = 'inline-block';
      if(outputElement) outputElement.innerText = "Processing with AI...";

      let targetUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
      if (useProxy) targetUrl = 'https://corsproxy.io/?' + encodeURIComponent(targetUrl);

      try {
        const response = await fetch(targetUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ contents: [{ parts: [{ text: payloadText }] }] }),
          referrerPolicy: 'no-referrer'
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.error?.message || response.statusText);
        if(!data.candidates || !data.candidates[0]) throw new Error("No response from AI");

        return data.candidates[0].content.parts[0].text.replace(/```json|```/g, "").trim();

      } catch (e) {
        let msg = "Error: " + e.message;
        if (e.message.includes('Failed to fetch')) msg += "\n(Try enabling Proxy in settings)";
        if(outputElement) outputElement.innerText = msg;
        throw e;
      } finally {
        btn.disabled = false; spinner.style.display = 'none';
      }
    }

    // --- LOGIC: AUTO-FILL ---
    async function runAutoFill() {
      const input = document.getElementById('smartInput').value;
      if(!input) return alert("Please enter text description.");
      
      let schema = [];
      fieldConfig.forEach(f => {
        if (!f.modes.includes(currentMode)) return;
        if (f.type === 'select') schema.push(`${f.id}: [${f.options.map(o=>o[1]).join(', ')}]`);
        else if (f.type === 'textarea') schema.push(`${f.id}: (Text description)`);
      });

      const prompt = `
        Act as a form-filler AI. Map this request: "${input}"
        To this JSON schema keys:
        ${schema.join('\n')}
        
        Rules:
        1. Select best matching values.
        2. Return ONLY JSON.
      `;

      try {
        const jsonStr = await fetchFromApi(prompt, null, 'btnAutoFill', 'spinAuto');
        const data = JSON.parse(jsonStr);
        for (const [key, value] of Object.entries(data)) {
          const el = document.getElementById(key);
          if (el && value) el.value = value;
          
          // Smart Parent Activation
          if(['gender', 'hairColor', 'clothing', 'ageGroup', 'bodyType'].includes(key)) {
             const chk = document.getElementById('describePerson');
             if(chk && !chk.checked) { chk.checked = true; }
          }
          if(['animalType', 'animalAppearance', 'animalAction'].includes(key)) {
             const chk = document.getElementById('describeAnimal');
             if(chk && !chk.checked) { chk.checked = true; }
          }
          if(['objectCategory', 'objectMaterial', 'objectDesc'].includes(key)) {
             const chk = document.getElementById('describeObject');
             if(chk && !chk.checked) { chk.checked = true; }
          }
        }
        
        // Refresh visibility of all sections
        handleVisibility();
        
      } catch (e) { console.error(e); }
    }

    // --- LOGIC: HIGH-END GENERATION ---
    async function callGeminiAPI() {
      const context = getSummaryText();
      if(!context) return alert("Konfiguration leer.");
      
      const prompt = `
        You are a World-Class AI Prompt Engineer for ${currentMode === 'video' ? 'Sora/Kling' : 'Flux/SDXL/Midjourney'}.
        
        INPUT DATA:
        ${context}

        TASK:
        Generate a strictly valid JSON payload optimized for high-end generation.
        
        RULES FOR PROMPTING:
        1. **Keywords**: Use top-tier keywords (e.g., 'award-winning', 'masterpiece', '8k uhd', 'volumetric lighting', 'subsurface scattering').
        2. **Structure**: 
           - 'Subject': detailed description.
           - 'Environment': atmosphere, background.
           - 'Lighting': specific light setup.
           - 'Camera': lens type, depth of field.
        3. **Negative Prompt**: Add a robust negative prompt for ${currentMode === 'video' ? 'video stability' : 'image quality'}.
        
        OUTPUT FORMAT (JSON Only):
        {
          "main_prompt": "The complete, cohesive prompt string...",
          "prompt_components": {
             "subject": "...",
             "environment": "...",
             "lighting": "...",
             "style": "..."
          },
          "negative_prompt": "...",
          "technical_parameters": {
             "width": ${currentMode === 'video' ? 1920 : 1024},
             "height": ${currentMode === 'video' ? 1080 : 1024},
             "steps": 30,
             "guidance_scale": 7.0,
             "sampler": "DPM++ 2M Karras",
             "seed": -1
          },
          "workflow_hints": "Suggestions for best results (e.g. 'Use Refiner', 'High Motion Bucket')"
        }
      `;

      try {
        const jsonStr = await fetchFromApi(prompt, document.getElementById('codeBlock'), 'optimizeAiBtn', 'aiSpinner');
        const json = JSON.parse(jsonStr);
        
        // Force Correct Resolution from UI
        if(getVal('aspectRatio')) {
            const res = getResolutionFromAspect(getVal('aspectRatio'));
            if(json.technical_parameters) {
                json.technical_parameters.width = res.w;
                json.technical_parameters.height = res.h;
            }
        }
        
        const code = document.getElementById('codeBlock');
        code.textContent = JSON.stringify(json, null, 2);
        if(window.Prism) Prism.highlightElement(code);
      } catch(e) { console.error(e); }
    }

    // --- LOGIC: LOCAL GENERATION ---
    function generateLocalJSON() {
      const context = getSummaryText();
      const res = getResolutionFromAspect(getVal('aspectRatio') || "1:1");
      
      const result = {
        main_prompt: context.replace(/\n/g, ', ').replace(/\|/g, ',') + ", masterpiece, best quality, 8k, ultra detailed",
        prompt_components: { raw_context: context },
        negative_prompt: "text, watermark, bad quality, blurry, ugly, deformed, mutation",
        technical_parameters: {
            width: res.w,
            height: res.h,
            aspect_ratio: getVal('aspectRatio') || "1:1"
        }
      };
      
      if (currentMode === 'video') {
          result.technical_parameters.fps = parseInt(getVal('fps')) || 24;
          result.technical_parameters.duration = getVal('duration') || "5s";
      }

      const code = document.getElementById('codeBlock');
      code.textContent = JSON.stringify(result, null, 2);
      if(window.Prism) Prism.highlightElement(code);
    }

    function copyResult() {
      const text = document.getElementById('codeBlock').innerText;
      navigator.clipboard.writeText(text).then(() => {
         const btn = document.getElementById('copyBtn');
         btn.innerHTML = "<i class='fa-solid fa-check'></i>";
         setTimeout(() => btn.innerHTML = "<i class='fa-regular fa-copy'></i> Kopieren", 2000);
      });
    }

    window.onload = () => { 
      loadKey();
      setMode('photo'); // Start in Photo Mode
    };
  </script>
</body>
</html>
