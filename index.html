<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sora Prompt Maker AI – Smart Edition</title>
  
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg-color: #020617; --sidebar-bg: #0f172a; --card-bg: #1e293b;
      --accent: #6366f1; --accent-hover: #4f46e5; --text-main: #f8fafc;
      --text-muted: #94a3b8; --border: #334155; --glow: 0 0 15px rgba(99, 102, 241, 0.2);
      --smart-bg: rgba(99, 102, 241, 0.1);
    }
    * { box-sizing: border-box; }
    body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--text-main); display: flex; flex-direction: column; min-height: 100vh; }
    
    /* Header */
    header { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(12px); padding: 0.8rem 2rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
    h1 { margin: 0; font-size: 1.2rem; font-weight: 700; display: flex; align-items: center; gap: 12px; letter-spacing: -0.02em; }
    h1 i { color: var(--accent); }
    
    .mode-switch { background: var(--card-bg); border-radius: 8px; padding: 4px; display: flex; border: 1px solid var(--border); }
    .mode-btn { background: transparent; border: none; color: var(--text-muted); padding: 6px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85rem; display: flex; gap: 6px; align-items: center; transition: all 0.2s; }
    .mode-btn.active { background: var(--accent); color: white; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }

    /* Layout */
    .container { display: grid; grid-template-columns: 450px 1fr; height: calc(100vh - 60px); }
    @media (max-width: 1000px) { .container { grid-template-columns: 1fr; height: auto; display: block; } }
    
    .sidebar { background: var(--sidebar-bg); border-right: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; height: 100%; }
    .scroll-area { flex: 1; overflow-y: auto; padding: 20px; }

    /* Smart Input Section */
    .smart-section {
      background: linear-gradient(180deg, rgba(99, 102, 241, 0.15) 0%, rgba(15, 23, 42, 0) 100%);
      padding: 20px; border-bottom: 1px solid var(--border);
    }
    .smart-label { font-size: 0.75rem; text-transform: uppercase; font-weight: 700; color: var(--accent); margin-bottom: 8px; letter-spacing: 1px; display: flex; align-items: center; gap: 6px; }
    .smart-textarea {
      width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--accent); color: white;
      border-radius: 8px; padding: 12px; font-family: inherit; font-size: 0.9rem; resize: vertical; min-height: 80px;
      margin-bottom: 10px; transition: all 0.2s;
    }
    .smart-textarea:focus { outline: none; box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.3); }
    
    .smart-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .btn-smart { padding: 8px; font-size: 0.85rem; border-radius: 6px; border: 1px solid var(--border); cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 6px; background: var(--card-bg); color: var(--text-main); transition: all 0.2s; }
    .btn-smart:hover { background: #334155; }
    .btn-magic { background: rgba(99, 102, 241, 0.2); border-color: var(--accent); color: white; }
    .btn-magic:hover { background: var(--accent); }

    /* Forms */
    .category-header { color: var(--text-main); margin-top: 30px; margin-bottom: 15px; font-size: 0.8rem; font-weight: 700; text-transform: uppercase; border-bottom: 1px solid var(--border); padding-bottom: 8px; display: flex; align-items: center; gap: 8px; }
    .form-group { margin-bottom: 15px; }
    label { display: block; font-size: 0.9rem; margin-bottom: 6px; font-weight: 600; }
    .field-desc { display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 8px; line-height: 1.3; font-style: italic; }
    select, input[type="text"] { width: 100%; background: #1e293b; border: 1px solid var(--border); color: var(--text-main); padding: 12px; border-radius: 8px; font-family: inherit; font-size: 0.9rem; transition: border 0.2s; }
    select:focus, input:focus { outline: none; border-color: var(--accent); }
    
    .toggle-wrapper { display: flex; align-items: center; gap: 12px; padding: 16px; background: rgba(99, 102, 241, 0.08); border-radius: 8px; border: 1px solid rgba(99, 102, 241, 0.2); margin-bottom: 20px; cursor: pointer; }
    input[type="checkbox"] { accent-color: var(--accent); width: 20px; height: 20px; margin: 0; cursor: pointer; }
    .toggle-wrapper label { margin: 0; cursor: pointer; }

    /* Main Content */
    .main-content { padding: 30px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; height: 100%; }
    .action-bar { display: grid; grid-template-columns: 1fr 2fr; gap: 15px; }
    .btn { padding: 14px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 0.95rem; transition: transform 0.1s; }
    .btn:active { transform: scale(0.98); }
    .btn-secondary { background: var(--card-bg); border: 1px solid var(--border); color: var(--text-main); }
    .btn-primary { background: linear-gradient(135deg, var(--accent), #818cf8); color: white; box-shadow: var(--glow); }
    .btn:disabled { opacity: 0.7; cursor: not-allowed; }

    .output-container { display: grid; grid-template-rows: auto 1fr; gap: 15px; flex: 1; min-height: 0; }
    .prompt-preview { background: var(--card-bg); border: 1px solid var(--border); border-radius: 10px; padding: 20px; }
    .prompt-preview h3 { margin: 0 0 10px 0; font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; }
    .prompt-text { font-family: 'Menlo', monospace; color: #cbd5e1; line-height: 1.6; font-size: 0.9rem; }
    .json-preview { background: #0d1117; border: 1px solid var(--border); border-radius: 10px; overflow: hidden; display: flex; flex-direction: column; min-height: 300px; }
    .json-header { background: #161b22; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
    pre { margin: 0; padding: 20px; overflow: auto; font-size: 0.85rem; flex: 1; }
    
    .api-settings { padding: 20px; background: rgba(15, 23, 42, 0.5); border-top: 1px solid var(--border); }
    .spinner { border: 2px solid rgba(255,255,255,0.3); border-top: 2px solid #fff; border-radius: 50%; width: 14px; height: 14px; animation: spin 1s linear infinite; display: none; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
  </style>
</head>
<body>

  <header>
    <h1><i class="fa-solid fa-wand-magic-sparkles"></i> Sora Prompt Maker <span style="font-size: 0.7em; opacity: 0.7; font-weight: 400; margin-left:10px;">Smart Edition</span></h1>
    <div class="mode-switch">
      <button class="mode-btn" id="modePhoto" onclick="setMode('photo')"><i class="fa-regular fa-image"></i> Foto</button>
      <button class="mode-btn active" id="modeVideo" onclick="setMode('video')"><i class="fa-solid fa-video"></i> Video</button>
    </div>
  </header>

  <div class="container">
    <aside class="sidebar">
      <div class="smart-section">
        <div class="smart-label"><i class="fa-solid fa-robot"></i> Smart Auto-Fill</div>
        <textarea id="smartInput" class="smart-textarea" placeholder="Beschreibe deine Idee (z.B. 'Eine Cyberpunk Frau im Regen von Tokio')..."></textarea>
        <div class="smart-controls">
          <button class="btn-smart" onclick="randomizeForm()">
            <i class="fa-solid fa-dice"></i> Random
          </button>
          <button class="btn-smart btn-magic" id="btnAutoFill" onclick="runAutoFill()">
            <span class="spinner" id="spinAuto"></span>
            <i class="fa-solid fa-wand-magic"></i> Auto-Fill
          </button>
        </div>
      </div>

      <div class="scroll-area" id="controls">
        </div>

      <div class="api-settings">
        <label for="apiKey" style="display:flex; justify-content:space-between;">Gemini API Key <span id="keyStatus" style="font-size:0.7em; color:var(--success);"></span></label>
        <input type="password" id="apiKey" placeholder="Hier API Key einfügen..." oninput="saveKey()" value="AIzaSyAMQ1acqN7GAGBT-dELwdBeBpDityuYy2s">
        
        <div style="display:flex; gap:10px; margin-top:10px;">
          <select id="modelSelect" style="font-size:0.8rem; padding:8px;">
            <option value="gemini-2.5-flash-preview-09-2025">Gemini 2.5 (Experimental)</option>
            <option value="gemini-1.5-flash">Gemini 1.5 (Stable)</option>
          </select>
        </div>

        <div style="margin-top:10px; padding-top:10px; border-top:1px solid #334155; display:flex; align-items:center; gap:8px;">
          <input type="checkbox" id="useProxy" onchange="toggleProxyWarning()">
          <label for="useProxy" style="margin:0; font-weight:400; color:#cbd5e1; font-size:0.8rem; cursor:pointer;">Proxy nutzen (Fix für "Failed to fetch")</label>
        </div>
        <div id="proxyWarn" style="display:none; font-size: 0.65rem; color: #fbbf24; margin-top: 4px; line-height:1.2;">
          <i class="fa-solid fa-triangle-exclamation"></i> Daten laufen über öffentlichen Proxy.
        </div>
      </div>
    </aside>

    <main class="main-content">
      <div class="action-bar">
        <button class="btn btn-secondary" id="updateLocalBtn" onclick="generateLocalJSON()">
          <i class="fa-solid fa-bolt"></i> Schnell (Lokal)
        </button>
        <button class="btn btn-primary" id="optimizeAiBtn" onclick="callGeminiAPI()">
          <span class="spinner" id="aiSpinner"></span>
          <i class="fa-solid fa-brain"></i> Mit AI Optimieren & Generieren
        </button>
      </div>

      <div class="output-container">
        <div class="prompt-preview">
          <h3>Aktueller Parameter Kontext</h3>
          <div id="rawPrompt" class="prompt-text">Warte auf Eingabe...</div>
        </div>
        <div class="json-preview">
          <div class="json-header">
            <span>JSON Output</span>
            <button class="mode-btn" id="copyBtn" onclick="copyResult()">Kopieren</button>
          </div>
          <pre><code id="codeBlock" class="language-json">// Klicke auf 'Auto-Fill' oder 'Optimieren'...</code></pre>
        </div>
      </div>
    </main>
  </div>

  <script>
    let currentMode = 'video';
    
    function getResolutionFromAspect(aspectRatio) {
      const map = {
        '16:9': { w: 1216, h: 832 }, '9:16': { w: 832, h: 1216 }, '1:1': { w: 1024, h: 1024 },
        '21:9': { w: 1344, h: 768 }, '4:3': { w: 1152, h: 896 }, '2.35:1': { w: 1408, h: 608 }, '5:4': { w: 1120, h: 896 }
      };
      return map[aspectRatio] || { w: 1024, h: 1024 };
    }

    // --- FELDER KONFIGURATION ---
    const fieldConfig = [
      { type: 'header', label: 'Person & Charakter', icon: 'fa-user', modes: ['photo', 'video'] },
      { type: 'checkbox', id: 'describePerson', label: 'Charakter aktivieren', default: true, modes: ['photo', 'video'] },
      { type: 'select', id: 'gender', label: 'Geschlecht', parent: 'describePerson', modes: ['photo', 'video'], options: [['Bitte wählen',''],['Frau','woman'],['Mann','man'],['Non-Binär','non-binary person'],['Roboter','robot'],['Cyborg','cyborg']] },
      { type: 'select', id: 'ageGroup', label: 'Alter', parent: 'describePerson', modes: ['photo', 'video'], options: [['Bitte wählen',''],['Kind','child'],['Teenager','teenager'],['20er','20s'],['30er','30s'],['40er','40s'],['50er','50s'],['60er','60s'],['70+ Senior','70s elderly']]},
      { type: 'select', id: 'ethnicity', label: 'Herkunft / Ethnie', parent: 'describePerson', modes: ['photo', 'video'], options: [['Bitte wählen',''],['Amerikanisch','American'],['Deutsch','German'],['Französisch','French'],['Italienisch','Italian'],['Skandinavisch','Scandinavian'],['Osteuropäisch','Eastern European'],['Kaukasisch (Allgemein)','Caucasian'],['Afrikanisch','African'],['Asiatisch','Asian'],['Latino','Latino'],['Arabisch','Middle Eastern'],['Indisch','Indian'],['Futuristisch','Futuristic']]},
      { type: 'select', id: 'bodyType', label: 'Körperbau', parent: 'describePerson', modes: ['photo', 'video'], options: [['Bitte wählen',''],['Schlank','slender'],['Athletisch','athletic'],['Muskulös','muscular'],['Kurvig','curvy'],['Plus Size','plus-size']] },
      { type: 'select', id: 'hairColor', label: 'Haarfarbe', parent: 'describePerson', modes: ['photo', 'video'], options: [['Bitte wählen',''],['Blond','blonde'],['Braun','brown'],['Schwarz','black'],['Rot','red'],['Grau/Weiß','gray/white'],['Bunt (Neon)','neon colorful'],['Glatze','bald']] },
      { type: 'select', id: 'hairStyle', label: 'Frisur', parent: 'describePerson', modes: ['photo', 'video'], options: [['Bitte wählen',''],['Lang & Glatt','long straight'],['Kurz','short crop'],['Locken','curly'],['Wellig','wavy'],['Zopf','ponytail'],['Bob','bob cut'],['Undercut','undercut'],['Messy Bun','messy bun']] },
      { type: 'select', id: 'eyeColor', label: 'Augenfarbe', parent: 'describePerson', modes: ['photo', 'video'], options: [['Bitte wählen',''],['Blau','blue'],['Grün','green'],['Braun','brown'],['Haselnuss','hazel'],['Grau','grey'],['Violett','violet'],['Heterochromie','heterochromia']] },
      { type: 'select', id: 'expression', label: 'Gesichtsausdruck', parent: 'describePerson', modes: ['photo', 'video'], options: [['Bitte wählen',''],['Neutral','neutral'],['Verliebt','in love, romantic gaze'],['Glücklich/Lächelnd','happy smiling'],['Ernst','serious'],['Wütend','angry'],['Traurig','sad'],['Überrascht','surprised'],['Verträumt','dreamy'],['Geheimnisvoll','mysterious']]},
      { type: 'select', id: 'clothing', label: 'Kleidung', parent: 'describePerson', modes: ['photo', 'video'], options: [['Bitte wählen',''],['Bikini / Badekleidung','bikini swimwear'],['Casual (T-Shirt)','casual t-shirt'],['Hoodie & Jeans','hoodie and jeans'],['Anzug (Business)','business suit'],['Abendkleid','evening gown'],['Lederjacke','leather jacket'],['Sci-Fi Rüstung','sci-fi armor'],['Cyberpunk Techwear','techwear'],['Mittelalter Robe','medieval robe'],['Sportbekleidung','sportswear']]},
      { type: 'textarea', id: 'action', label: 'Handlung', parent: 'describePerson', modes: ['photo', 'video'], placeholder: 'Was tut die Person? (z.B. sitzt am Fenster, rennt...)' },
      
      { type: 'header', label: 'Szene & Welt', icon: 'fa-earth-europe', modes: ['photo', 'video'] },
      { type: 'select', id: 'sceneType', label: 'Setting / Genre', modes: ['photo', 'video'], options: [['Bitte wählen',''],['Cinematic Realism','cinematic realism'],['Cyberpunk','cyberpunk'],['Sci-Fi','sci-fi'],['Fantasy','fantasy'],['Horror / Dark','horror dark atmosphere'],['Film Noir','film noir'],['Steampunk','steampunk'],['Dokumentarisch','documentary style'],['Retro / Vintage','retro vintage'],['Natur / Landschaft','nature landscape'],['Studio / Portrait','studio photography'],['Weltraum / Space','outer space'],['Unterwasser','underwater'],['Post-Apokalyptisch','post-apocalyptic'],['Abstrakt / Surreal','abstract surrealism']]},
      { type: 'select', id: 'location', label: 'Ort', modes: ['photo', 'video'], options: [['Bitte wählen',''],['Wohnzimmer (Modern)','modern living room'],['Schlafzimmer (Morgensonne)','bedroom morning light'],['Luxus-Küche','luxury kitchen'],['Badezimmer (Spa)','spa bathroom'],['Büro / Office','corporate office'],['Hotellobby','hotel lobby'],['Supermarkt','supermarket aisle'],['Nachtclub / Bar','nightclub bar'],['Museum / Galerie','art museum gallery'],['Klassenzimmer','classroom'],['Krankenhaus','hospital corridor'],['Garage / Werkstatt','garage workshop'],['Dachboden (Dusty)','dusty attic'],['Keller (Dark)','dark basement'],['Café / Coffee Shop','cozy coffee shop'],['Bibliothek','grand library'],['Dachterrasse (Nacht)','rooftop terrace at night'],['U-Bahn Station','subway station'],['Tropischer Strand','tropical beach'],['Schneebedeckter Berg','snowy mountain peak'],['Futuristisches Labor','high-tech laboratory'],['Raumschiff Inneres','spaceship interior'],['Alte Ruinen','ancient ruins'],['Fußballstadion','football stadium'],['New York Straße','NYC street'],['Tokio Neon Distrikt','Tokyo neon district'],['Waldlichtung','forest glade'],['Wüste','desert dunes'],['Weißer Raum','white infinite room'],['Schloss','gothic castle']]},
      { type: 'select', id: 'era', label: 'Zeit / Ära', modes: ['photo', 'video'], options: [['Bitte wählen',''],['Modern','modern day'],['2000er (Y2K)','2000s Y2K aesthetic'],['90er Jahre','1990s'],['80er Jahre','1980s'],['70er Jahre','1970s'],['60er Jahre','1960s'],['Zukunft (2077)','year 2077'],['Mittelalter','medieval era'],['Viktorianisch','victorian era'],['Antike','ancient period']]},
      { type: 'select', id: 'lighting', label: 'Beleuchtung', modes: ['photo', 'video'], options: [['Bitte wählen',''],['Filmisch','cinematic lighting'],['Natürlich','natural light'],['Golden Hour','golden hour'],['Neon','neon lights'],['Dunkel / Moody','dark moody lighting'],['Studio Softbox','studio softbox']] },
      { type: 'select', id: 'weather', label: 'Wetter', modes: ['photo', 'video'], options: [['Bitte wählen',''],['Sonnig','sunny'],['Regen','rainy'],['Sturm','stormy'],['Schnee','snowing'],['Nebel','foggy']] },
      
      { type: 'header', label: 'Kamera & Look', icon: 'fa-camera', modes: ['photo', 'video'] },
      { type: 'select', id: 'aspectRatio', label: 'Seitenverhältnis', desc: 'Format des Bildes (Breite x Höhe) für verschiedene Plattformen.', modes: ['photo', 'video'], options: [['16:9 (Breitbild)','16:9'],['9:16 (Story/Reels)','9:16'],['1:1 (Quadrat)','1:1'],['21:9 (Kino)','21:9'],['4:3 (TV)','4:3'],['2.35:1 (Cinemascope)','2.35:1'],['5:4 (Mittelformat)','5:4']] },
      { type: 'select', id: 'viewAngle', label: 'Kameraperspektive', desc: 'Bestimmt den Blickwinkel.', modes: ['photo', 'video'], options: [['Bitte wählen',''],['Augenhöhe (Neutral)','eye-level shot'],['Froschperspektive (Machtvoll)','low angle shot from below'],['Vogelperspektive (Übersicht)','high angle shot from above'],['Gottesperspektive (Top-Down)','top-down bird\'s eye view'],['Over-the-Shoulder (Dialog)','over-the-shoulder shot'],['Dutch Angle (Schräg/Dynamisch)','dutch angle tilted shot'],['POV (Ego-Perspektive)','point-of-view shot'],['Makro (Extrem Nah)','macro close-up'],['Weitwinkel (Viel Umgebung)','wide angle shot'],['Fischauge (Verzerrt)','fisheye lens distortion'],['Teleobjektiv (Komprimiert)','telephoto lens compression'],['Kniehöhe (Kindersicht)','knee-level shot'],['Drohnenflug (Luftaufnahme)','aerial drone shot'],['Isometrisch (3D-Plan)','isometric view']] },
      { type: 'select', id: 'filmStock', label: 'Film Look / Grading', desc: 'Farbgebung und Textur.', modes: ['photo', 'video'], options: [['Bitte wählen',''],['Digital Clean (Modern)','digital crisp 8k'],['Kodak Portra 400 (Natürlich)','Kodak Portra 400 film'],['Cinestill 800T (Nacht/Neon)','Cinestill 800T film'],['Fujifilm Velvia (Lebendig)','Fujifilm Velvia 50'],['Kodak Tri-X (Schwarz-Weiß)','Kodak Tri-X 400 B&W'],['Technicolor (Retro 50er)','Technicolor process'],['Bleach Bypass (Harter Kontrast)','bleach bypass process'],['VHS (90er Glitch)','VHS tape quality'],['Polaroid (Sofortbild)','Polaroid photo style'],['Sepia (Historisch)','sepia toned vintage'],['Lomo (Vignette)','Lomo camera style'],['Infra-Rot (Surreal)','infrared photography'],['Cross Processed (Experimentell)','cross processed film']] },
      { type: 'select', id: 'renderEngine', label: 'Qualität / Stil', desc: 'Der technische oder künstlerische Stil.', modes: ['photo', 'video'], options: [['Bitte wählen',''],['Fotorealistisch','photorealistic'],['Unreal Engine 5 (Game)','Unreal Engine 5 render'],['Octane Render (3D)','Octane render'],['V-Ray (Architektur)','V-Ray render'],['Blender Cycles','Blender Cycles'],['Stop Motion (Knete)','stop motion claymation'],['Pixar / Disney (3D Animation)','Pixar style 3D animation'],['Anime (Japanisch)','anime style'],['Ölgemälde (Klassisch)','oil painting style'],['Aquarell (Weich)','watercolor painting'],['Cyberpunk Digital','cyberpunk digital art'],['Pixel Art (Retro)','pixel art'],['Cel Shading (Comic)','cel shaded'],['Vector Art (Clean)','flat vector art']] },
      
      { type: 'header', label: 'Video Spezifikationen', icon: 'fa-film', modes: ['video'] },
      { type: 'select', id: 'cameraMotion', label: 'Kamerabewegung', modes: ['video'], options: [['Statisch','static'],['Sanfter Zoom','slow zoom'],['Pan Rechts','pan right'],['Tracking Shot','tracking shot'],['Handheld','handheld shaky'],['FPV Drohne','FPV drone']] },
      { type: 'select', id: 'fps', label: 'Framerate', modes: ['video'], options: [['24 FPS (Kino)','24'],['30 FPS (TV)','30'],['60 FPS (Smooth)','60']] },
      { type: 'select', id: 'duration', label: 'Dauer', modes: ['video'], options: [['5 Sekunden','5s'],['10 Sekunden','10s']] },
      { type: 'select', id: 'loop', label: 'Endlosschleife', modes: ['video'], options: [['Nein','false'],['Ja','true']] }
    ];

    // --- UI LOGIC ---
    function setMode(mode) {
      currentMode = mode;
      document.getElementById('modePhoto').classList.toggle('active', mode === 'photo');
      document.getElementById('modeVideo').classList.toggle('active', mode === 'video');
      renderForm();
    }

    function renderForm() {
      const container = document.getElementById('controls');
      container.innerHTML = ''; 
      fieldConfig.forEach(field => {
        if (!field.modes.includes(currentMode)) return;
        if (field.type === 'header') {
          container.innerHTML += `<div class="category-header"><i class="fa-solid ${field.icon}"></i> ${field.label}</div>`;
          return;
        }
        const group = document.createElement('div');
        group.className = 'form-group';
        if(field.parent) group.dataset.parent = field.parent;

        if (field.type === 'checkbox') {
          group.className = 'toggle-wrapper';
          group.innerHTML = `<input type="checkbox" id="${field.id}" ${field.default ? 'checked' : ''} onchange="handleVisibility()"><label for="${field.id}">${field.label}</label>`;
        } else {
          let inputHTML = `<label>${field.label}`;
          if(field.desc) inputHTML += ` <span class="field-desc">${field.desc}</span>`;
          inputHTML += `</label>`;
          
          if (field.type === 'textarea') {
            inputHTML += `<textarea id="${field.id}" rows="2" placeholder="${field.placeholder || ''}" oninput="updateSummary()"></textarea>`;
          } else {
            let opts = field.options.map(o => `<option value="${o[1]}">${o[0]}</option>`).join('');
            inputHTML += `<select id="${field.id}" onchange="updateSummary()">${opts}</select>`;
          }
          group.innerHTML = inputHTML;
        }
        container.appendChild(group);
      });
      handleVisibility();
      updateSummary();
    }

    function handleVisibility() {
      const chk = document.getElementById('describePerson');
      if(!chk) return;
      document.querySelectorAll('[data-parent="describePerson"]').forEach(el => {
        el.style.display = chk.checked ? 'block' : 'none';
      });
      updateSummary();
    }

    function getVal(id) { const el = document.getElementById(id); return el ? el.value : ''; }

    function getSummaryText() {
      let parts = [];
      if(document.getElementById('describePerson')?.checked) {
        const pParts = [getVal('gender'), getVal('ageGroup'), getVal('ethnicity'), getVal('bodyType'), getVal('hairColor') ? getVal('hairColor') + ' hair' : '', getVal('hairStyle'), getVal('eyeColor') ? getVal('eyeColor') + ' eyes' : '', getVal('expression'), getVal('clothing'), getVal('action')];
        const pText = pParts.filter(p => p && p !== '').join(' ');
        if(pText) parts.push("PERSON: " + pText);
      }
      const sParts = [getVal('sceneType'), getVal('location'), getVal('era'), getVal('weather'), getVal('lighting')];
      const sText = sParts.filter(p => p && p !== '').join(', ');
      if(sText) parts.push("SCENE: " + sText);
      const cParts = [getVal('viewAngle'), getVal('filmStock'), getVal('renderEngine')];
      const cText = cParts.filter(p => p && p !== '').join(', ');
      if(cText) parts.push("CAMERA: " + cText);
      if (currentMode === 'video') {
          const vParts = [getVal('cameraMotion'), getVal('fps') ? getVal('fps') + 'fps' : ''];
          const vText = vParts.filter(p => p && p !== '').join(', ');
          if(vText) parts.push("VIDEO: " + vText);
      }
      return parts.join(' | ');
    }

    function updateSummary() {
      document.getElementById('rawPrompt').innerText = getSummaryText() || "Warte auf Eingabe...";
    }

    // --- FUNKTION: RANDOMIZE ---
    function randomizeForm() {
      fieldConfig.forEach(field => {
        if (!field.modes.includes(currentMode)) return;
        if (field.type === 'select' && field.options.length > 1) {
          const el = document.getElementById(field.id);
          if(el) {
            const randomIdx = Math.floor(Math.random() * (field.options.length - 1)) + 1;
            el.value = field.options[randomIdx][1];
          }
        }
      });
      updateSummary();
    }

    // --- KEY MANAGEMENT (LocalStorage) ---
    function saveKey() {
      const key = document.getElementById('apiKey').value;
      localStorage.setItem('gemini_api_key', key);
      updateKeyStatus(true);
    }

    function loadKey() {
      const stored = localStorage.getItem('gemini_api_key');
      // Always prioritize the hardcoded key if user hasn't set one yet
      // But if user typed one, use that.
      if (stored) {
        document.getElementById('apiKey').value = stored;
        updateKeyStatus(true);
      } else {
        // Fallback is already in HTML 'value' attribute
        updateKeyStatus(true); // Technically 'saved' in code
      }
    }

    function updateKeyStatus(found) {
      const el = document.getElementById('keyStatus');
      if (found) {
        el.innerText = '● Gespeichert';
        el.style.color = 'var(--success)';
      } else {
        el.innerText = '○ Nicht gespeichert';
        el.style.color = 'var(--text-muted)';
      }
    }
    
    function toggleProxyWarning() {
      const useProxy = document.getElementById('useProxy').checked;
      document.getElementById('proxyWarn').style.display = useProxy ? 'block' : 'none';
    }

    // --- FUNKTION: DIRECT API CALL HELPER ---
    async function fetchFromApi(payloadText, outputElement, buttonId, spinnerId) {
      const apiKey = document.getElementById('apiKey').value;
      const useProxy = document.getElementById('useProxy').checked;
      const model = document.getElementById('modelSelect').value;
      
      if (!apiKey) {
        alert("Bitte gib zuerst deinen Google Gemini API Key ein!");
        document.getElementById('apiKey').focus();
        throw new Error("Missing API Key");
      }

      const btn = document.getElementById(buttonId);
      const spinner = document.getElementById(spinnerId);
      
      btn.disabled = true; spinner.style.display = 'inline-block';
      if(outputElement) outputElement.innerText = useProxy ? `Sende über Proxy an ${model}...` : `Sende direkt an ${model}...`;

      // Endpoint construction based on selection
      let targetUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
      
      // Apply Proxy if selected
      if (useProxy) {
        targetUrl = 'https://corsproxy.io/?' + encodeURIComponent(targetUrl);
      }

      try {
        const response = await fetch(targetUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ contents: [{ parts: [{ text: payloadText }] }] }),
          referrerPolicy: 'no-referrer' // CRITICAL for direct calls from some hosts
        });

        const data = await response.json();
        
        if (!response.ok) {
           let errMsg = data.error?.message || response.statusText;
           throw new Error(`API Fehler (${response.status}): ${errMsg}`);
        }

        if(!data.candidates || !data.candidates[0]) {
           throw new Error("Keine Antwort von Gemini erhalten.");
        }

        let txt = data.candidates[0].content.parts[0].text;
        return txt.replace(/```json|```/g, "").trim();

      } catch (e) {
        let msg = "FEHLER: " + e.message;
        if (e.message.includes('Failed to fetch')) {
          msg += "\n\nNETZWERK-BLOCKADE:\n1. Deaktivieren Sie AdBlocker für diese Seite.\n2. Aktivieren Sie die Checkbox 'Proxy nutzen' in den Einstellungen links.\n3. Probieren Sie das Gemini 1.5 Modell.";
        } else {
          msg += "\n\nTipps:\n1. Prüfen Sie Ihren API Key.\n2. Wählen Sie 'Gemini 1.5' im Dropdown aus.\n3. Aktivieren Sie den Proxy.";
        }
        
        if(outputElement) outputElement.innerText = msg;
        throw e;
      } finally {
        btn.disabled = false; spinner.style.display = 'none';
      }
    }

    // --- FUNKTION: AUTO-FILL (SMART INPUT) ---
    async function runAutoFill() {
      const input = document.getElementById('smartInput').value;
      if(!input) return alert("Bitte Text eingeben!");
      
      // 1. Schema erstellen (damit die AI weiß, welche Werte erlaubt sind)
      let schemaDescription = [];
      
      fieldConfig.forEach(f => {
        if (!f.modes.includes(currentMode)) return; // Nur aktive Felder
        if (f.type === 'select') {
           // Liste der erlaubten Werte erstellen
           const options = f.options.map(o => `${o[1]} (${o[0]})`).join(', ');
           schemaDescription.push(`Field "${f.id}" (Select): Choose one of [${options}]`);
        } else if (f.type === 'textarea') {
           schemaDescription.push(`Field "${f.id}" (Text): Summarize relevant details.`);
        }
      });

      const schemaStr = schemaDescription.join('\n');
      
      const prompt = `
        Role: Intelligent Form Filler.
        Task: Map the user's natural language description to specific form values.
        
        User Description: "${input}"
        
        Target Form Schema (IDs and allowed values):
        ${schemaStr}
        
        Instructions:
        1. Analyze the User Description.
        2. For each field in the schema, pick the best matching value from the allowed options.
        3. If the description implies a value (e.g. "cyberpunk city" -> sceneType="cyberpunk", location="NYC street" if implied), set it.
        4. If a specific detail is missing in the description, DO NOT invent one. Leave the field out of the JSON.
        5. Return a flat JSON object where keys are the Field IDs and values are the chosen values.
        
        Output format: JSON ONLY. No markdown.
      `;

      try {
        const jsonStr = await fetchFromApi(prompt, null, 'btnAutoFill', 'spinAuto');
        const data = JSON.parse(jsonStr);
        
        // Werte anwenden
        let count = 0;
        for (const [key, value] of Object.entries(data)) {
          const el = document.getElementById(key);
          if (el && value) {
            // Check if it's a checkbox we need to activate parent for?
            // The logic currently hides fields based on 'describePerson'.
            // If the AI returns person attributes, we should ensure describePerson is checked.
            if(['gender', 'hairColor', 'clothing'].includes(key)) {
               const chk = document.getElementById('describePerson');
               if(chk && !chk.checked) { chk.checked = true; handleVisibility(); }
            }
            
            el.value = value;
            count++;
          }
        }
        updateSummary();
        // Optional: Feedback
        const btn = document.getElementById('btnAutoFill');
        const oldHtml = btn.innerHTML;
        btn.innerHTML = `<i class="fa-solid fa-check"></i> ${count} Felder`;
        setTimeout(() => btn.innerHTML = oldHtml, 2000);
        
      } catch (e) {
        console.error(e);
        if(!e.message.includes('Failed to fetch')) alert("Auto-Fill Fehler: " + e.message);
      }
    }

    // --- FUNKTION: FINAL GENERATE ---
    async function callGeminiAPI() {
      const context = getSummaryText();
      if(!context) return alert("Keine Parameter.");
      
      const prompt = `
        Role: Expert Video AI Prompt Engineer.
        Task: Create a high-quality JSON payload for Sora/Kling based on context.
        Context: ${context}
        Output: Strict JSON.
        Format: { "prompt": "...", "negative_prompt": "...", "parameters": { "width": 1920, "height": 1080 } }
      `;

      try {
        const jsonStr = await fetchFromApi(prompt, document.getElementById('codeBlock'), 'optimizeAiBtn', 'aiSpinner');
        const json = JSON.parse(jsonStr);
        
        if(getVal('aspectRatio')) {
            const res = getResolutionFromAspect(getVal('aspectRatio'));
            if(!json.parameters) json.parameters = {};
            json.parameters.width = res.w;
            json.parameters.height = res.h;
        }
        
        const code = document.getElementById('codeBlock');
        code.textContent = JSON.stringify(json, null, 2);
        if(window.Prism) Prism.highlightElement(code);
      } catch(e) { console.error(e); }
    }

    // --- LOKAL ---
    function generateLocalJSON() {
      const context = getSummaryText();
      const result = {
        prompt: context.replace(/\|/g, '.'),
        negative_prompt: "bad quality, blurry",
        settings: { width: 1920, height: 1080, aspect: getVal('aspectRatio') || "16:9" }
      };
      const code = document.getElementById('codeBlock');
      code.textContent = JSON.stringify(result, null, 2);
      if(window.Prism) Prism.highlightElement(code);
    }

    function copyResult() {
      const text = document.getElementById('codeBlock').innerText;
      const textArea = document.createElement("textarea");
      textArea.value = text;
      document.body.appendChild(textArea);
      textArea.select();
      try {
        document.execCommand('copy');
        const btn = document.getElementById('copyBtn');
        btn.innerHTML = "<i class='fa-solid fa-check'></i>";
        setTimeout(() => btn.innerHTML = "Kopieren", 2000);
      } catch (err) {
        alert("Kopieren fehlgeschlagen.");
      }
      document.body.removeChild(textArea);
    }

    window.onload = () => { 
      loadKey();
      setMode('video'); 
    };
  </script>
</body>
</html>
